name: Auto-CI-PYTEST-PYLINT-SNYK

on:
  push:
    branches:
      - development

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v3
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pylint pytest httpx
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Run pylint on app.py
      run: |
        pylint app.py | tee pylint_report.txt || true  # Analiza solo app.py y guarda el resultado

    - name: Show pylint results in job summary
      if: always()
      run: |
        echo "## üìù Pylint Report (app.py)" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        cat pylint_report.txt >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

    - name: Run pytest on test/*.py
      run: |
        pytest test/*.py  --disable-warnings  | tee pytest_report.txt || true

    - name: Show pytest results in job summary
      if: always()
      run: |
        echo "## üìù Pytest Execution Report" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        cat pytest_report.txt >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

    - name: Install Snyk CLI manually (using wget)
      run: |
        wget https://github.com/snyk/snyk/releases/download/v1.100.0/snyk-linux -O /usr/local/bin/snyk
        chmod +x /usr/local/bin/snyk  # Cambia los permisos para hacerlo ejecutable

    - name: Run Snyk Code Analysis (SAST)
      if: success()  # Solo se ejecuta si pylint y pytest son exitosos
      run: snyk code test --sarif > snyk-code.sarif || true
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_AUTH_TOKEN }}

    - name: Upload Snyk Code Results to GitHub Security
      if: success()  # Solo se ejecuta si el an√°lisis de Snyk es exitoso
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: snyk-code.sarif
